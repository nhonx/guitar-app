<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket Guitar Fits</title>
    <style>
        :root {
            --wood-dark: #2d1b15;
            --wood-light: #5d4037;
            --sidebar-bg: #1a1a1a;
            --active-color: #ff9800;
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0; padding: 0; background: #000;
            height: 100dvh; /* Dynamic viewport height */
            width: 100vw; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; flex-direction: column;
        }

        /* --- ORIENTATION LOCK --- */
        @media screen and (orientation: portrait) {
            #rotate-message { display: flex !important; }
            #main-app { display: none !important; }
        }
        #rotate-message {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
        }

        /* --- MAIN LAYOUT --- */
        #main-app {
            display: flex; flex-direction: row; width: 100%; height: 100%;
            padding-left: var(--safe-left); 
        }

        /* --- GUITAR BODY --- */
        #guitar-body {
            flex: 1;
            background: radial-gradient(circle at 40% 50%, var(--wood-light) 0%, var(--wood-dark) 60%, #000 95%);
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #sound-hole {
            position: absolute; top: 50%; left: -20%;
            transform: translate(0, -50%);
            height: 90%; aspect-ratio: 1/1;
            background: #100805; border-radius: 50%;
            border: 6px solid #4e342e;
            box-shadow: inset 0 0 50px #000; z-index: 0;
        }

        #settings-trigger {
            position: absolute; top: 10px; left: 10px;
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.6); border: 1px solid #555;
            border-radius: 50%; color: white; font-size: 1.2rem;
            display: flex; justify-content: center; align-items: center;
            z-index: 100; cursor: pointer; backdrop-filter: blur(4px);
        }

        /* --- STRINGS --- */
        #strings-container {
            z-index: 10;
            display: flex; flex-direction: column;
            justify-content: space-between;
            padding: 10vh 0; 
            height: 100%; width: 100%;
        }

        .string { position: relative; width: 100%; height: 40px; display: flex; align-items: center; }
        .string-line { width: 100%; box-shadow: 0 3px 6px rgba(0,0,0,0.8); transition: transform 0.05s; }
        
        .s0 .string-line { height: 4.5px; background: #ffb74d; }
        .s1 .string-line { height: 3.8px; background: #ffb74d; }
        .s2 .string-line { height: 3.2px; background: #ffb74d; }
        .s3 .string-line { height: 2.5px; background: #ffb74d; }
        .s4 .string-line { height: 1.5px; background: #cfd8dc; }
        .s5 .string-line { height: 1.0px; background: #cfd8dc; }

        .vibrating .string-line { animation: vibrate 0.15s linear infinite; }
        @keyframes vibrate { 0% { transform: translateY(0); } 50% { transform: translateY(2px); } 100% { transform: translateY(0); } }

        /* --- OPTIMIZED CHORD BAR --- */
        #chord-bar {
            width: calc(85px + var(--safe-right));
            min-width: calc(85px + var(--safe-right));
            height: 100%;
            background: var(--sidebar-bg);
            border-left: 2px solid #333;
            display: flex; flex-direction: column;
            align-items: center;
            
            /* DYNAMIC SPACING: Gap scales with screen height */
            gap: 1.5vh; 
            padding: 1.5vh 5px;
            padding-right: calc(5px + var(--safe-right)); 
            
            overflow-y: auto; 
            overflow-x: hidden;
            z-index: 20;
            box-shadow: -5px 0 15px rgba(0,0,0,0.6);
        }

        .chord-btn {
            /* AUTO-SCALING SIZE: 
               - Min: 40px (Smallest usable touch target)
               - Preferred: 13% of screen height
               - Max: 65px (Don't get too huge on tablets)
            */
            width: clamp(40px, 13vh, 65px);
            height: clamp(40px, 13vh, 65px);
            
            /* Ensure it stays circular */
            border-radius: 50%;
            aspect-ratio: 1/1;
            flex-shrink: 0; /* Prevent squashing if list is very long */

            border: 2px solid #444;
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            color: #ddd; 
            
            /* Font size scales with button */
            font-size: clamp(0.7rem, 2.2vh, 1.1rem);
            font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            transition: all 0.1s;
        }

        .chord-btn.active {
            background: var(--active-color); color: #2d1b15;
            border-color: var(--active-color); transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
        }

        .chord-btn.add-btn {
            background: transparent; border: 1px dashed #555; color: #888;
            font-size: 1.5rem;
        }

        /* --- SETTINGS MODAL --- */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            flex-direction: column; align-items: center;
            padding: 20px var(--safe-right) 20px var(--safe-left);
            overflow-y: auto;
        }

        .modal-content { width: 100%; max-width: 500px; padding-bottom: 40px; }
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-title { color: #fff; font-size: 1.2rem; font-weight: bold; }
        .close-icon { font-size: 1.5rem; color: #888; cursor: pointer; }
        .setting-label { color: var(--active-color); font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px; margin-top: 15px; }

        .sound-options { display: flex; gap: 8px; }
        .sound-btn { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #aaa; border-radius: 6px; font-size: 0.8rem; }
        .sound-btn.selected { background: var(--active-color); color: #000; font-weight: bold; }

        .chord-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 6px; }
        .lib-btn { aspect-ratio: 1/1; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; font-size: 0.8rem; }
        .lib-btn.added { border-color: var(--active-color); color: var(--active-color); background: #331f00; }

        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>

    <div id="rotate-message">
        <div style="font-size:3rem; margin-bottom:15px;">⟳</div>
        <h3>Please Rotate to Landscape</h3>
    </div>

    <div id="start-overlay">
        <h1 style="margin-bottom: 5px; color: var(--active-color);">Pocket Guitar</h1>
        <p style="color:#aaa; font-size: 0.9rem; margin-bottom: 25px;">Select tone</p>
        <div class="sound-options" style="width: 250px; margin-bottom: 25px;">
            <button class="sound-btn selected" data-tone="acoustic">Acoustic</button>
            <button class="sound-btn" data-tone="electric">Clean</button>
            <button class="sound-btn" data-tone="distortion">Rock</button>
        </div>
        <button id="start-btn" style="padding:12px 50px; background:var(--active-color); border:none; border-radius:30px; font-weight:bold; color:#000;">PLAY</button>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Settings</span>
                <span class="close-icon" id="close-settings">✕</span>
            </div>
            
            <div class="setting-label">Tone</div>
            <div class="sound-options">
                <button class="sound-btn selected" data-tone="acoustic">Acoustic</button>
                <button class="sound-btn" data-tone="electric">Clean</button>
                <button class="sound-btn" data-tone="distortion">Rock</button>
            </div>

            <div class="setting-label">Chord Library</div>
            <div class="chord-grid" id="library-grid"></div>
        </div>
    </div>

    <div id="main-app">
        <div id="settings-trigger">⚙</div>
        <div id="guitar-body">
            <div id="sound-hole"></div>
            <div id="strings-container">
                <div class="string s0"><div class="string-line"></div></div>
                <div class="string s1"><div class="string-line"></div></div>
                <div class="string s2"><div class="string-line"></div></div>
                <div class="string s3"><div class="string-line"></div></div>
                <div class="string s4"><div class="string-line"></div></div>
                <div class="string s5"><div class="string-line"></div></div>
            </div>
        </div>
        <div id="chord-bar"></div>
    </div>

<script>
    /** DATA & CONFIG */
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    const baseFreqs = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];

    const toneProfiles = {
        acoustic: { type: 'triangle', attack: 0.01, decay: 1.2, gain: 0.35 },
        electric: { type: 'sine', attack: 0.02, decay: 2.5, gain: 0.3 }, 
        distortion: { type: 'sawtooth', attack: 0.01, decay: 0.8, gain: 0.15 } 
    };
    let currentTone = 'acoustic';

    const chordLibrary = {
        'C':  [3, 3, 2, 0, 1, 0], 'Cm': [3, 3, 5, 5, 4, 3],
        'D':  [2, 0, 0, 2, 3, 2], 'Dm': [0, 0, 0, 2, 3, 1],
        'E':  [0, 2, 2, 1, 0, 0], 'Em': [0, 2, 2, 0, 0, 0],
        'F':  [1, 3, 3, 2, 1, 1], 'Fm': [1, 3, 3, 1, 1, 1],
        'G':  [3, 2, 0, 0, 0, 3], 'Gm': [3, 5, 5, 3, 3, 3],
        'A':  [0, 0, 2, 2, 2, 0], 'Am': [0, 0, 2, 2, 1, 0],
        'B':  [2, 2, 4, 4, 4, 2], 'Bm': [2, 2, 4, 4, 3, 2]
    };

    let activeChords = ['C', 'G', 'Am', 'Em', 'D', 'F'];
    let currentChord = activeChords[0];

    /** AUDIO */
    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playString(index, delay = 0) {
        if (!audioCtx) return;
        const now = audioCtx.currentTime + delay;
        const shape = chordLibrary[currentChord] || chordLibrary['C'];
        if (shape[index] === -1) return; 

        const freq = baseFreqs[index] * Math.pow(2, shape[index] / 12);
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const profile = toneProfiles[currentTone];

        osc.type = profile.type;
        osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(profile.gain, now + profile.attack);
        gain.gain.exponentialRampToValueAtTime(0.001, now + profile.decay);

        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + profile.decay);

        setTimeout(() => animateString(index), delay * 1000);
    }

    function animateString(index) {
        const el = document.querySelectorAll('.string-line')[index];
        if(el) {
            el.classList.remove('vibrating');
            void el.offsetWidth;
            el.classList.add('vibrating');
            setTimeout(() => el.classList.remove('vibrating'), 200);
        }
    }

    /** UI LOGIC */
    const chordBar = document.getElementById('chord-bar');
    const settingsModal = document.getElementById('settings-modal');
    const libraryGrid = document.getElementById('library-grid');

    function renderChordBar() {
        chordBar.innerHTML = ''; 
        activeChords.forEach(chord => {
            const btn = document.createElement('button');
            btn.className = `chord-btn ${chord === currentChord ? 'active' : ''}`;
            btn.textContent = chord;
            
            const activate = (e) => {
                e.preventDefault(); e.stopPropagation();
                document.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentChord = chord;
            };
            btn.addEventListener('touchstart', activate);
            btn.addEventListener('mousedown', activate);
            chordBar.appendChild(btn);
        });
        
        const addBtn = document.createElement('button');
        addBtn.className = 'chord-btn add-btn';
        addBtn.textContent = '+';
        addBtn.onclick = openSettings;
        chordBar.appendChild(addBtn);
    }

    function renderSettings() {
        libraryGrid.innerHTML = '';
        Object.keys(chordLibrary).sort().forEach(chord => {
            const btn = document.createElement('button');
            const isAdded = activeChords.includes(chord);
            btn.className = `lib-btn ${isAdded ? 'added' : ''}`;
            btn.textContent = chord;
            btn.onclick = () => {
                if (activeChords.includes(chord)) {
                    activeChords = activeChords.filter(c => c !== chord);
                    btn.classList.remove('added');
                } else {
                    activeChords.push(chord);
                    btn.classList.add('added');
                }
                if(activeChords.length === 0) activeChords = ['C']; 
                if(!activeChords.includes(currentChord)) currentChord = activeChords[0];
                renderChordBar();
            };
            libraryGrid.appendChild(btn);
        });
        updateToneUI();
    }

    function setTone(tone) {
        currentTone = tone;
        updateToneUI();
    }

    function updateToneUI() {
        document.querySelectorAll('.sound-btn').forEach(btn => {
            btn.classList.toggle('selected', btn.dataset.tone === currentTone);
        });
    }

    document.querySelectorAll('.sound-btn').forEach(btn => {
        btn.addEventListener('click', (e) => setTone(e.target.dataset.tone));
    });

    function openSettings() {
        renderSettings();
        settingsModal.style.display = 'flex';
    }
    document.getElementById('settings-trigger').addEventListener('click', openSettings);
    document.getElementById('close-settings').addEventListener('click', () => settingsModal.style.display = 'none');

    document.getElementById('start-btn').addEventListener('click', () => {
        initAudio();
        document.getElementById('start-overlay').style.display = 'none';
        renderChordBar();
        setTimeout(updateGeom, 100);
    });

    /** INPUT ENGINE */
    const stringsContainer = document.getElementById('strings-container');
    const stringElements = document.querySelectorAll('.string');
    let stringGeom = [];
    let activeTouches = {};

    function updateGeom() {
        stringGeom = Array.from(stringElements).map(el => {
            const rect = el.getBoundingClientRect();
            return { center: rect.top + rect.height/2 };
        });
    }
    window.addEventListener('resize', updateGeom);

    function handleMove(e) {
        e.preventDefault();
        Array.from(e.changedTouches).forEach(t => {
            const prevY = activeTouches[t.identifier];
            const currY = t.clientY;
            let hits = [];
            
            stringGeom.forEach((str, idx) => {
                if ((prevY < str.center && currY >= str.center) || 
                    (prevY > str.center && currY <= str.center)) {
                    const dist = Math.abs(currY - prevY);
                    const progress = dist === 0 ? 0 : Math.abs(str.center - prevY) / dist;
                    hits.push({ idx, progress });
                }
            });

            hits.sort((a,b) => a.progress - b.progress);
            hits.forEach(h => playString(h.idx, h.progress * 0.04));
            activeTouches[t.identifier] = currY;
        });
    }

    stringsContainer.addEventListener('touchstart', (e) => {
        initAudio();
        if(stringGeom.length === 0) updateGeom();
        Array.from(e.changedTouches).forEach(t => {
            activeTouches[t.identifier] = t.clientY;
            stringGeom.forEach((str, idx) => {
                if (Math.abs(t.clientY - str.center) < 30) playString(idx);
            });
        });
    }, {passive: false});

    stringsContainer.addEventListener('touchmove', handleMove, {passive: false});
    stringsContainer.addEventListener('touchend', e => {
        Array.from(e.changedTouches).forEach(t => delete activeTouches[t.identifier]);
    });

    // Mouse Fallback
    let isMouseDown = false; let lastMouseY = 0;
    stringsContainer.addEventListener('mousedown', e => {
        isMouseDown = true; lastMouseY = e.clientY;
        stringGeom.forEach((str, idx) => { if (Math.abs(e.clientY - str.center) < 20) playString(idx); });
    });
    window.addEventListener('mousemove', e => {
        if(!isMouseDown) return;
        if(activeTouches['m'] === undefined) activeTouches['m'] = lastMouseY;
        const mockE = { changedTouches: [{identifier: 'm', clientY: e.clientY}], preventDefault: ()=>{} };
        handleMove(mockE);
    });
    window.addEventListener('mouseup', () => { isMouseDown = false; delete activeTouches['m']; });

</script>
</body>
</html>